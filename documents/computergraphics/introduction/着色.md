[TOC]

参考资料：

- [GAMES101_Lecture_07_Shading 1](./resources/GAMES101/GAMES101_Lecture_07_Shading 1.pdf)
- [GAMES101_Lecture_07_Shading 2](./resources/GAMES101/GAMES101_Lecture_07_Shading 2.pdf)
- [GAMES101_Lecture_07_Shading 3](./resources/GAMES101/GAMES101_Lecture_07_Shading 3.pdf)
- [GAMES101-现代计算机图形学入门-闫令琪](https://www.bilibili.com/video/BV1X7411F744?p=6)



**在计算机图形学中，着色就是对不同物体应用不同材质的过程。**



先来看一张照片：

<img src="./resources/images/6.1.png" style="zoom:60%;" />

观察上图中的茶杯，不难发现光源在右上侧方向，茶杯在光照下明显有几处特征：

- 在图中①所标记位置，可以观察到高光（Specular highlights）。
- 在茶杯表面其余位置，如②，整个茶杯的明暗是否变化的，学习过物理后我们知道这是光的漫反射（Diffuse reflection）引起的。
- 在茶杯的提手附近位置，按理来讲光源是无法直接照射到的，但是我们依然能够看到，说明还是有光经过这些位置的反射到达了我们的眼中。虽然光源无法直达，但是由于除了茶杯之外的其他物体发生了漫反射，总会有一部分光到达这些位置，然后反射到我们眼中，这部分光称为环境光（Ambient lighting）。



在计算机图形学中，通过**布林冯反射模型**来实现着色。



# 布林冯反射模型



**布林冯反射模型定义要从三个角度考虑来完成着色：**

- **漫反射**
- **高光**
- **环境光**



**着色点**

我们知道，实际中的物体表面可能是平面，也可能是曲面，但是，在图形学中，我们规定，在一个极小的范围内，物体的表面就是一个平面，这个范围称为**着色点（shading point）**。

同时，在 shading point 上做一些其他的定义，如下图：

<img src="./resources/images/6.2.png" style="zoom:75%;" />

- 观测方向，$\vec{v}$
- 物体表面法线，$\vec{n}$
- 光线方向，$\vec{l}$
- 物体表面属性，如颜色等



**shading $\ne$​ shadow**

在着色中，只考虑物体表面对光的反射，不考虑物体是否被遮挡，是否在阴影中等问题。



## 漫反射

首先，来回顾下漫反射的**特点**，如下图：

- 光线向各个方向均匀的散射。
- 在任意方向看到的物体表面颜色都是相同的。

<img src="./resources/images/6.3.png" style="zoom:75%;" />



**那么，在上面的茶杯示例中，为什么一个杯子的不同位置有明暗的区别呢？**



假设存在如下这样一束光，垂直照射物体表面，那么着色点可以接收到全部的光线：

<img src="./resources/images/6.4.png" style="zoom:100%;" />

如果物体表面倾斜一定角度，那么只能接收到部分光线：

<img src="./resources/images/6.5.png" style="zoom:100%;" />

接下来，将着色点的一系列定义应用到这个物体表面：

<img src="./resources/images/6.6.png" style="zoom:100%;" />

不难发现，可以直接用光线防线 $\vec{l}$ 和法线方向 $\vec{n}$ 之间的夹角 **$\theta$** 来描述物体表面接收到的光纤多少，**$\theta$** 越大，接收到的光线越少，应用向量点乘，可以得到
$$
cos\theta = \vec{l}·\vec{n}
$$


依然以茶杯为例，如果从距离茶杯10m远的位置和1m远的位置分别看茶杯，茶杯同一位置的亮度肯定是不同的，一定是1m的距离看要更亮一些，生活经验可以给我们这个结论，究其原因，很简单，一定是更远的距离导致进入我们眼睛的光线更少，从而茶杯更暗。 但是只知道原因不够的，在计算机图形学中，需要能够量化接收到的光线才能够进行渲染。

那么，**对于不同位置接收到的光线强度是如何量化的呢？**



来看下面这张图：

<img src="./resources/images/6.7.png" style="zoom:50%;" />

上图中，中心点表示光源，光源外一个一个圆表示不同大小的球面（由于在三维空间中），距离光源最近的球面与光源的距离为单位距离1，我们定义，该球面上任一点接收到的光线强度为 $I$，根据能量守恒原理，照射到最外侧球面（距离光源距离为 $r$​）上的光线总强度是不变的，那么该球面上任一点接收到的光线强度为 $I/r^2$​。

这样，我们就可以将不同距离接收到的光线强度进行量化了。



好，通过上面对**物体表面的倾斜角度对接收到的光线强度的影响**和**物体到光源的距离对接收到的光线强度的影响**，可以整理得到计算漫反射光的公式：

<img src="./resources/images/6.8.png" style="zoom:75%;" />

- 通过 $I/r^2$ 可以计算得到着色点位置可以接收到的光的强度。

- 通过 $\vec{n}·\vec{l}$​ 可以计算得到由于着色点表面的倾斜，可以接收到的光的强度。这里为什么要用 $max(0, \vec{n}·\vec{l})$​ 呢？我们知道当 $\theta > 90°$ 时，$cos\theta < 0$​​​，​​​光线根本就照射不到着色点表面，没有意义，直接取0即可。

- $k_d$​ 表示漫反射系数，物体对光漫反射后，我们除了可以看到明暗的区别，还能看到物体的颜色，这个颜色就可以用漫反射系数来体现，将其表示成rgb三通道的向量，便可以计算得到漫反射后的颜色。通过下图可直观的看到不同的漫反射系数对结果的影响：

  <img src="./resources/images/6.9.png" style="zoom:75%;" />

- 从公式中可以看到，计算漫反射光与观测方向 $\vec{v}$ 无关，这也符合漫反射的特征。



## 高光

想必大家对这种小镜子并不陌生：

<img src="./resources/images/6.10.png" style="zoom:75%;" />

甚至绝大多数人对其都有年少的回忆，在中午的教室窗边，拿出小镜子将阳光反射到墙面上，或者晃一晃同学:satisfied:......  当反射后的光晃到我们的眼睛时，会非常的刺眼，眼中所见全是白茫茫的光亮，我们知道，这是镜面反射。



那么在文章最开始的茶杯例子中，我们看到的那些高光的位置，同样只能看到白色光亮而看不到杯子本身的颜色，这与镜面反射是不是有什么关系呢？答案是肯定的，当我们的**观测方向** $\vec{v}$ **越接近光线的镜面反射反向 $\vec{R}$ (即两者的夹角越小)，高光越明显**，如下图所示：

<img src="./resources/images/6.11.png" style="zoom:75%;" />

要计算 $\vec{v}$ 与 $\vec{R}$ 的夹角是比较困难的，布林冯模型巧妙地将引入**半程向量** $\vec{h}$ 来解决这个问题，如下图：

<img src="./resources/images/6.12.png" style="zoom:75%;" />

- 所谓半程向量 $\vec{h}$​​​​，就是 $\vec{l}$​​​​ 和 $\vec{v}$​​​​ 的角平分线方向，计算半程向量方向很简单，根据平行四边形法则，只需要将 $\vec{l}$​​​​ 和 $\vec{v}$​​​​ 相加然后再除以二者长度即可。那么为什么引入半程向量呢？观察上面两个图可以发现，观测方向 $\vec{v}$​​​​ 与镜面反射方向 $\vec{R}$​​​​ 的夹角越小，则发现 $\vec{n}$​​​​ 与半程向量 $\vec{h}$​​​​ 的夹角 $\alpha$​​​​​ 越小，那么就可以通过 $\alpha$​ 的大小来判断高光的亮度。

- 高光还需要考虑物体的镜面系数 $k_s$，以及接收到的光线强度 $I/r^2$。

- 在公式的最后部分 $max(0,\vec{n}·\vec{h})^p$，为什么加入一个指数 $p$ 呢？这与余弦函数的特性有关，下面是不同的指数 $p$ 对余弦函数的影响：

  <img src="./resources/images/6.13.png" style="zoom:75%;" />

  当 $p=1$ 时，$\alpha$​ 的角度范围非常大，体现到计算高光的结果中，意味着观测方向与镜面反射方向的夹角比较大时也能看叫高光现象，这显然有很大的误差。通过增大 $p$ 的值，$\alpha$ 的角度范围越来越小，就越来越接近实际的高光效果。



最后，再来直观地看一下 $k_s$ 和 $p$ 对高光渲染的影响：

<img src="./resources/images/6.14.png" style="zoom:75%;" />



## 环境光

在文章开遍的茶杯例子中，虽然杯子的有些位置是光源无法直接照射到的，但是我们仍然能看到这些位置，这是因为这些位置接受并反射了各种环境中反射过来的光。

在布林冯反射模型中，**假设**任意位置接收到的环境光照强度为一**固定值** $I_\alpha$​，同样需要考虑物体的环境光系数 $k_\alpha$，那么可以得到环境光的计算公式，如下图：

<img src="./resources/images/6.15.png" style="zoom:75%;" />

既然 $I_\alpha$ 和 $k_\alpha$ 都是固定值，那么最后计算出的环境光 $L_\alpha$ 就一定是固定值，考虑到 $k_\alpha$​ 中包含了物体的颜色，其实最后环境光计算出来之后就是一个固定的颜色，主要就是用来提高亮度，保证没有完全黑暗的部分。



**切记：<font color="red">布林冯模型中的环境光是假设的，真实的环境光不是固定值。</font>**



到这里，布林冯反射模型就介绍完毕了，来看一下将漫反射、高光和环境光全部加到一起后的着色效果吧：

<img src="./resources/images/6.16.png" style="zoom:75%;" />



# 着色频率

首先，来看一组着色效果图：

<img src="./resources/images/6.17.png" style="zoom:75%;" />

很明显，从左到右，着色的效果越来越好，左图是对多个三角形组成的平面进行着色；中图是对每个三角形的定点进行着色，三角形内部通过差值法来实现平滑的过度效果；右图是对每个像素进行着色。这三种着色方式，就分别对应下面三种着色频率：



## Flat shading

对每个三角形进行着色，通过三角形的两条边的叉积得到三角形平面的法线方向，然后进行着色。这种着色方式不适合光滑的平面。

<img src="./resources/images/6.18.png" style="zoom:100%;" />



## Gouraud shading

对每个三角形的定点进行着色，求出每个定点的法线，然后计算着色。三角形内部通过差值法进行着色。

<img src="./resources/images/6.19.png" style="zoom:100%;" />



## Phong shading

对每个像素进行着色。

<img src="./resources/images/6.20.png" style="zoom:100%;" />



在对比选择三种着色频率时，需要根据模型的实际情况进行选择：

<img src="./resources/images/6.21.png" style="zoom:75%;" />

通过上图可以看到，当模型精细（包含的三角形数量多）到一定程度，Flat shading就能够得到很不错的着色效果，这种情况下，选择Phong shading不但对着色效果的提升有限，而且还会加大计算量，得不偿失。



# 图形管线

图形管线（Graphics Pipeline）就是从"场景输入$\Rightarrow$投影变换$\Rightarrow$光栅化$\Rightarrow$着色$\Rightarrow$​​渲染输出" 的一系列过程。如下图：

<img src="./resources/images/6.22.png" style="zoom:75%;" />

现在的GPU已经集成好了这一整套过程，我们只需要输入，GPU即可完成渲染输出，只不过，在一些GPU中允许用户都这一过程中的部分环节进行自定义编程（可以通过OpenGL等API），如着色，从而使渲染效果更加灵活。
