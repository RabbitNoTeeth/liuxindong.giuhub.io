[TOC]

MySQL默认支持多种存储引擎，用户可以根据应用的需要选择如何存储和索引数据，是否使用事务等。

MySQL 5.0支持的存储引擎包括: MyISAM、InnoDB、BDB、MEMORY、MERGE、EXAMPLE、NDB Cluster、ARCHIVE、CSV、BLOCKHOLE、FEDERATED等。

本篇文章将主要讲解MyISAM、InnoDB、MEMORY、MERGE四种存储引擎。



# 1 SQL语句

## 1.1 创建表时设置

```
create table 表名 (字段...) engine=存储引擎名称
```



## 1.2 修改表存储引擎

```
alter table 表名 engine=存储引擎名称
```



## 1.3 查看当前的默认存储引擎

```
show variables like ‘table_type’
```



## 1.4 查询当前数据库支持的存储引擎

```
show engines \G
```



# 2 特性


首先，通过一张表来概括常用的存储引擎的特性对比。

|      特点      | MyISAM | InnoDB | MEMORY | MERGE | NDB  |
| :------------: | :----: | :----: | :----: | :---: | :--: |
|    存储限制    |   有   |  64TB  |   有   | 没有  |  有  |
|    事务安全    |        |  支持  |        |       |      |
|     锁机制     |  表锁  |  行锁  |  表锁  | 表锁  | 行锁 |
|    B树索引     |  支持  |  支持  |  支持  | 支持  | 支持 |
|    哈希索引    |        |        |  支持  |       | 支持 |
|    全文索引    |  支持  |        |        |       |      |
|    集群索引    |        |  支持  |        |       |      |
|    数据缓存    |        |  支持  |  支持  |       | 支持 |
|    索引缓存    |  支持  |  支持  |  支持  | 支持  | 支持 |
|   数据可压缩   |  支持  |        |        |       |      |
|    空间使用    |   低   |   高   |  N/A   |  低   |  低  |
|    内存使用    |   低   |   高   |  中等  |  低   |  高  |
| 批量插入的速度 |   高   |   低   |   高   |  高   |  高  |
|    支持外键    |        |  支持  |        |       |      |



## 2.1 MyISAM

MyISAM是MySQL 5.5之前的默认存储引擎，5.5之后改为了InnoDB。

MyISAM不支持事务，不支持外键，其优势是访问速度快。

适用场景：主要以读和插入操作为主，很少的更新和删除操作，并且对并发要求不高。



### 2.1.1 存储方式

每个MyISAM表在磁盘上存储成3个文件，文件名和表名相同，但是扩展名不同，分别为：`.frm` 、`.MYD`、`.MYI`，分别存储表定义、表数据和表索引。

数据文件和索引文件可以放在不同的目录，平均分布IO，提高访问速度。要指定索引文件和数据文件的保存路径，需要在创建表的时候通过`DATA DIRECTORY`和`INDEX DIRECTORY`语句指定。

MyISAM类型的表可能会损坏，损坏后的表不能被访问，可以通过 `check table 表名` 来检查表是否健康，并用`repair table 表名`来修复损坏的表。



### 2.1.2 存储格式

MyISAM还支持3种不同的存储格式:

1. 静态表
   默认的存储格式。静态表中的字段都是非变长字段，每个记录都是固定长度的。这样的优点是存储非常迅速，容易缓存，出现故障容易修复；缺点是占用的空间通常比动态表多。
   静态表的数据在存储时会按照固定的长度来补足空格，但是在查询时会去掉这些空格。这样就有一个问题值得注意：当应用要存储的数据本身就有空格时，使用静态表查询时会丢失尾部的空格，如果这些空格是应用必需的，那么就不适合使用静态表。
2. 动态表
   动态表中包含变长字段，记录不是固定长度的。这种存储的优点就是占用空间相对较少，但是频繁的更新和删除记录会产生碎片，需要定期执行`optimize table 表名`语句或者`myisamchk-r`命令来改善性能，并且在出现故障时恢复相对比较困难。
3. 压缩表
   由myisam工具创建，占用非常小的磁盘空间。因为每个记录都是被单独压缩的，所以只有非常小的访问开支。



## 2.2 InnoDB

提供了具有提交、回滚和崩溃恢复能力的事务安全，但是相比MyISAM，InnoDB写的处理效率差一些，并且会占用更多的磁盘空间。

适用场景：并发条件下对数据一致性的要求，以及对数据准确性要求高的场景。



### 2.2.1 自动增长列

InnoDB表的自动增长列可以手工插入，但是插入的值如果是0或者空，那么实际插入的值是自动增长后的值。

可以通过`alter table 表名 auto_increment=n`语句来设置自动增长的初始值，默认为1。但是该语句设置的初始值是保存在内存中的，如果数据库重启，那么这个初始值会失效，需要重新设置。

对于InnoDB表，自动增长列必须是索引。如果是组合索引，也必须是组合索引的第一列。



### 2.2.2 外键约束

MySQL支持外键的存储引擎只有InnoDB。

创建外键约束的语句: 

```
create table 表名 (id int primary key,
...,
constraint ‘外键名称’ foreign key (当前表字段) references 父表名 (父表字段) on delete restrict on update cascade)
```

在创建索引时，可以指定在删除和更新父表时，对子表进行相应的操作，包括`restrict`、`cascade`、`set null`和`no action`。其中`restrict`和`no action`相同，是指限制在子表有关联记录的情况下父表不能更新；`cascade`表示父表在更新或者删除时更新或者删除子表对应记录；`set null`表示父表在更新或者删除时，子表对应字段被设置为null。

当某个表被其他表创建了外键参照，那么该表对应的索引或者主键被禁止删除。

在导入多个表的数据时，如果需要忽略表之间的导入顺序，可以通过`set foreign key checks=0`来暂时关闭外键检查，导入后通过`set foreign key checks=1`恢复外键检查。



### 2.2.3 存储方式

1. 共享表空间存储
   这种方式创建的表的表结构存储在`.frm`文件中，数据和索引保存在`innodb_data_home_dir`和`innodb_data_file_path`定义的表空间中，可以是多个文件。

2. 多表空间存储
   这种方式创建的表的表结构仍然存储在`.frm`文件中，但是每个表的数据和索引单独保存在`.ibd`中，如果是分区表，则每个分区对应单独的`.ibd`文件，文件名是”表名+分区名”，可以在创建分区的时候指定每个分区的数据文件的位置，以此来将表的io均匀分布在多个磁盘上。

   要使用多表空间的存储方式，需要设置参数`innodb_file_per_table`，并且重新启动服务后才可以生效，对于新建的表按照多表空间的方式创建，已有的表仍然使用共享表空间存储。如果将已有的多表空间方式修改回共享表空间的方式，那么只有新建表会在共享表空间，原有的表仍然使用多表空间，也就是说，多表空间的参数设置，只对新建表起作用。

   多表空间的数据文件大小没有限制，直接复制`.ibd`和`.frm`文件是无法恢复多表空间特性的表的，但是可以通过如下命令:
   `alter table 表名 discard 表空间`
   `alter table 表名 import 表空间`



## 2.3 MEMORY

MEMORY使用存在于内存中的内容来创建表，每个MEMORY表实际只对应一个`.frm`文件。因为数据存储在内存中，所以MEMORY表的访问速度非常快，并且默认使用hash索引，但是一旦服务关闭，MEMORY表的数据就会丢失。

在启动mysql服务时，可以通过`--init-file`选项加载sql文件，从文件中加载数据。在不需要MEMORY表时，要及时释放，直接删除整个表。



## 2.4 MERGE

MERGE存储引擎是一组MyISAM表的组合,这些MyISAM表必须结构完全相同. MERGE表本身没有数据,所有的操作实际上都是对内部MyISAM表进行的. MERGE的优点在于可以突破单个MyISAM表大小的限制,并且通过不同的表分布在多个磁盘上,可以改善MERGE的访问效率.

对于MERGE的插入操作,可以通过`insert_method`来定义插入的表,有3个可选值:`first`, `last`,`no`. first表示将插入值插入到第一个MyISAM表中;last表示将插入值插入最后一个MyISAM表中;no或者不设置表示禁止插入操作.

创建MERGE表语句:
`create table 表名 (...) engine=merge union=(表1,表2...) insert_method=last;`