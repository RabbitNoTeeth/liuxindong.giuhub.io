[TOC]

分区是指根据一定的规则，数据库把一个表分解成多个更小的、更容易管理的部分。分区引入了分区键的概念，分区键用于计算分区依据。



# 1 分区类型

## 1.1 Range 分区

按照Range分区的表是利用取值范围将数据分区，区间要连续并且不能相互重叠，使用 `values less than` 操作符进行分区定义。Range分区的声明需要遵守由小到大的顺序。

Range分区在MySQL 5.5之后不仅支持整数分区，而且还支持非整数分区，如日期字符串等。



**示例：id列作为分区键**

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by range (id)( 
    partition p1 values less than (10), 
    partition p2 values less than (20), 
    partition p3 values less than (30) 
);
```



向User表中插入 id=31 的数据会出现错误，因为超出了分区范围，这是可以使用 `values less than MAXVALUE` 来解决 （MAXVALUE 表示最大的整数值）。

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by range (id)( 
    partition p1 values less than (10), 
    partition p2 values less than (20), 
    partition p3 values less than (30)， 
    partition p4 values less than MAXVALUE 
);
```



**适用场景**：

1. 需要删除过期数据时，只需删除分区即可。
2. 经常运行包含分区键的查询。



## 1.2 List 分区

List分区时根据枚举列表的值进行分区，声明时不必遵守任何顺序。

List分区在MySQL 5.5之后不仅支持整数分区，而且还支持非整数分区，如日期字符串等。



**示例：id作为分区键**

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by range (id)( 
    partition p1 values in (1，2，3), 
    partition p2 values in (5，6), 
    partition p3 values in (10) 
);
```


向User表中插入id为4的数据会报错，因为枚举列表值中不包含4。



## 2.3 Columns 分区

Columns分区可以细分为 Range Columns 分区和 List Columns 分区，两者都支持整数、日期时间、字符串三大数据类型。

Columns分区还支持多列分区。



**示例：**

```
create table User( 
    id int not null, 
    age int not null 
) partition by range columns(id,age)( 
    partition p1 values less than (10,20), 
    partition p2 values less than (20,30), 
    partition p3 values less than (30,40)， 
    partition p4 values less than (MAXVALUE, MAXVALUE) 
);
```



## 2.4 Hash分区

Hash分区主要用来分散热点读，使数据在各个分区尽可能平均分布。在进行Hash分区时，MySQL会对分区键应用一个散列函数，以此确定数据放在哪个分区。Hash分区允许用户使用自定义的表达式。

**MySQL支持两种Hash分区：**

1. 常规Hash分区

   使用的是取模算法。优点是数据分布比较均匀，缺点是当增加或者删除分区时，其他分区的数据都需要重新计算分区。

2. 线性Hash分区

   使用的是一个线性的2的幂运算。优点是增加或删除分区时，不需要重新计算；缺点是数据的分布不如常规Hash均匀。

   

**示例：常规Hash分区，分区数为4**

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by hash (id) partitions 4;
```


**示例：线性Hash分区,分区数为4**

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by linear hash (id) partitions 4;
```



## 2.5 Key分区

Key分区不允许用户使用自定义的表达式，Key分区支持除了BLOB和Text类型之外的所有类型作为分区键。



**示例：id作为分区键，分区数为4**

```
create table User( 
    id int not null, 
    name varchar(10) 
) partition by key (id) partitions 4;
```



**注意：**

1. 在创建Key分区时，可以不指定分区键，这是默认使用主键作为分区键。
2. 如果没有主键，那么选择非空唯一键作为分区键；
3. 如果两者都没有，那就必须指定分区键。
4. 创建Key分区时同样可以使用linear关键字，和Hash分区有相同的含义。



# 2 键值为null时的处理

Range分区中，null值会被当做最小值处理。

List分区中，null值必须出现在枚举列表才允许插入。

Hash和Key分区中，null值被当作0来处理。



# 3 分区管理

## 3.1 Range分区和List分区

### 3.1.1 增加分区

**增加Range分区**

增加Range分区时，添加的分区必须是分区列表最大的一端。

```
alter table User add partition (partition p4 values less than (100));
```



**增加List分区**

增加List分区时，新的枚举列表值必须是原有枚举列表中不包含的值。

```
alter table User add partition (partition p4 values in (100,200));
```



### 3.1.2 删除分区

```
alter table User drop partition 分区名;
```



### 3.3.3 合并和拆分分区

在合并或者拆分Range分区或者List分区时，只能操作相邻的分区，不能跳过某个分区进行操作。



**合并Range分区**

```
alter table User reorganize partition p1,p2,p3 into( 
    partiton p1 values less than 30 
);
```



**合并List分区**

```
alter table User reorganize partition p1,p2,p3 into( 
    partiton p1 values in (1,2,3,5,6) 
);
```



**拆分Range分区**

```
alter table User reorganize partition p1 into( 
    partiton p1 values less than 10 
    partiton p2 values less than 20 
    partiton p3 values less than 30 
);
```


**拆分List分区**

```
alter table User reorganize partition p1 into( 
    partiton p1 values in (1,2) 
    partiton p1 values in (3,5) 
    partiton p1 values in (6) 
);
```



## 3.2 Hash分区和Key分区

Hash分区和Key分区无法直接删除分区，只能通过合并分区来减少分区个数，但是不会造成数据的丢失。



### 3.2.1 增加分区

```
alter table User add partition partitions 8;
```



### 3.2.2 减少分区（合并分区）

```
alter table User coalesce partition 4;
```